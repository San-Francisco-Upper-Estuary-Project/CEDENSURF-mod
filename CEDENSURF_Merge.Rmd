---
title: "CEDENSURF_Merge"
author: "Erika W"
date: "2/18/2021"
output:
  html_document:
    code_download: true
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=F, message=F}
library(data.table)
library(lubridate)
library(sf)
library(tidyverse)
```

## Load Data

### CEDEN

Two files - one with tox data, and one with wq data

```{r}
# Load CEDEN Data
CEDENMod_Tox <- fread("https://github.com/WWU-IETC-R-Collab/CEDEN-mod/raw/main/Data/Output/CEDENMod_Toxicity.csv")

CEDENMod_WQ <- fread("https://github.com/WWU-IETC-R-Collab/CEDEN-mod/raw/main/Data/Output/CEDENMod_WQ.csv")
```

### SURF

Two files - one with wq data, and one with SED data ?
```{r}
SURFMod_SED <- fread("https://github.com/WWU-IETC-R-Collab/CEDENSURF-mod/raw/main/Data/Output/SURFMod_SED.csv")

SURFMod_WQ <- fread("https://github.com/WWU-IETC-R-Collab/CEDENSURF-mod/raw/main/Data/Output/SURFMod_water.csv")
```
### Append with source

```{r}
CEDENMod_Tox$Source <- rep("Ceden", times=nrow(CEDENMod_Tox))

CEDENMod_WQ$Source <- rep("Ceden", times=nrow(CEDENMod_WQ))

SURFMod_SED$Source <- rep("SURF", times=nrow(SURFMod_SED))

SURFMod_WQ$Source <- rep("SURF", times=nrow(SURFMod_WQ))
```

## Remove duplicate data

More investigating will probably be better, but for now we can simply remove those data defined in SURF as sourced from CEDEN

```{r}

SURFMod_WQ <- filter(SURFMod_WQ, Data.source != "CEDEN")
```

An alternate method might be to look for data that match in three specific columns, following the merge; like date, stationname, and result

```{r}
# Ideas from: https://www.datasciencemadesimple.com/remove-duplicate-rows-r-using-dplyr-distinct-function/

# Remove duplicate rows of the dataframe using multiple variables

# distinct(MergedData, Date, StationName, Result, .keep_all= TRUE)
```

## Water Quality Sets

### Correct mismatched column names

Rather than using Steven's method of renaming using a list (which is dependent on an expected number and order of column names), I renamed each column individually

```{r}
SURFMod_WQ$Unit <- "ppb"

SURFMod_WQ <- SURFMod_WQ %>% rename(Date = Sample_date,
          Analyte = Chemical_name, 
          Result = Concentration..ppb., 
          CollectionMethod = Sample_type, 
          StationCode = Site_code,
          StationName = Site_name,
          MDL = Method_detection_level..ppb.,
          LOQ = Level_of_quantification..ppb.)

sort(names(SURFMod_WQ))

# Project oriented - not in CEDEN 
# Agency, County, Data.source, Study_cd, Study_description, Study_weblink, 

# Others not in CEDEN : LOQ

# CEDENMod_WQ <- CEDENMod_WQ %>% rename()

sort(names(CEDENMod_WQ)) 

# what is matrix name? Appears to be less granular data compared to collection_method

# Datum is the geo projection

# Project oriented - not in SURF
# Parent Project, Program, Project, Regional Board, rb_number, regional_board
```

### Match columns

To do the merge even though there are columns without matches in each dataset, we can give both datasets identical columns and allow them to be filled with NA's when those columns are not actually present.

```{r}
C <- names(CEDENMod_WQ)
S <- names(SURFMod_WQ)

# Add missing columns to CEDEN and order alphabetically 

diff<- setdiff(S, C) # gives items in S that are not in C

CEDENMod_WQ[, diff] <- NA

diff<- setdiff(C, S) # gives items in C that are not in S

SURFMod_WQ[, diff] <- NA
```

Reorder columns to match
```{r}
C <- sort(names(CEDENMod_WQ))
S <- sort(names(SURFMod_WQ))

SURFMod_WQ <- SURFMod_WQ %>% select(S)

CEDENMod_WQ <- CEDENMod_WQ %>% select(C)

# Check once all columns have perfect matches?
tibble(SURF = names(SURFMod_WQ), CEDEN = names(CEDENMod_WQ))
```
### Merge

```{r}
CEDENSURF_WQ <- rbind(CEDENMod_WQ, SURFMod_WQ)

head(CEDENSURF_WQ)
```
## Tox Data Sets


